<% require 'uri' -%>

<% @backends.keys.sort.each do |name| -%>

<% if @backends[name].kind_of?(Array) -%>

director <%= name %> round-robin {
<% @backends[name].sort.each do |member| -%>
  <% uri = URI(member) -%>
  {
     .backend = {
       .host = "<%= uri.host %>";
       .port = "<%= uri.port %>";
       .probe = {
         .url = "<%= uri.path %>";
         .timeout = 3s;
         .interval = 10s;
         .threshold = 3;
       }
     }
  }
<% end -%>
}

<% else -%>

backend <%= name %> {
    <% uri = URI(@backends[name]) -%>
    .host = "<%= uri.host %>";
    .port = "<%= uri.port %>";
}

<% end -%>

<% end -%>

backend status {
   .host = "localhost";
   .port = "8080";
   .connect_timeout = 10s;
   .first_byte_timeout = 10s;
   .between_bytes_timeout = 10s;
}

sub vcl_recv {
  set req.grace = 10h;
  remove req.http.Cookie;

  if (req.http.host == "localhost") {
    set req.backend = status;
  }

<% @backends.keys.sort.each do |name| -%>
  if (req.http.host == "<%= name %>.<%= @domain %>"<% if @vhosts.keys.include?(name) -%> || req.http.host == "<%= @vhosts[name] %>"<% end -%>) {
    set req.http.host = "<%= @vhosts[name] %>";
    set req.backend = <%= name %>;
  }
<% end -%>
}

sub vcl_fetch {
  set beresp.grace = 10h;
}
