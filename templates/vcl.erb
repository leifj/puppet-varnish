
<% @backends.each do |name,host| -%>

backend <%= name %> {
    .host = "<%= host %>";
}

<% end -%>

backend status {
   .host = "localhost";
   .port = 9999;
}

sub vcl_recv {
  set req.grace = 10h;
  if (req.http.host == "localhost") {
    set req.backend = status;
  }
<% @backends.each do |name,host| -%>
  if (req.http.host == "<%= name %>.<%= @domain %>") {
    set req.http.host = "<%= host %>";
    set req.backend = <%= name %>;
  }
<% end -%>
}

sub vcl_fetch {
  set beresp.grace = 10h;
}
